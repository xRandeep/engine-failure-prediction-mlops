name: Predictive Maintenance MLOps Pipeline

# Trigger: Run on push to main OR manual button click
on:
  push:
    branches: [ "main" ]
  workflow_dispatch:

jobs:
  build-train-deploy:
    runs-on: ubuntu-latest
    
    steps:
    # 1. Checkout the Code
    - name: Checkout Repository
      uses: actions/checkout@v3

    # 2. Set up Python
    - name: Set up Python 3.9
      uses: actions/setup-python@v4
      with:
        python-version: '3.9'

    # 3. Install Dependencies
    - name: Install Python Libraries
      run: |
        python -m pip install --upgrade pip
        if [ -f requirements.txt ]; then pip install -r requirements.txt; fi
        # Ensure MLOps libraries are installed
        pip install huggingface_hub joblib scikit-learn pandas datasets mlflow

    # 4. Register Raw Data (Ingestion)
    - name: Register Raw Data to Hugging Face
      env:
        HF_TOKEN: ${{ secrets.HF_TOKEN }}
        HF_USERNAME: "iStillWaters"
        DATASET_REPO_NAME: "auto_predictive_maintenance_data"
      run: |
        python src/register_data.py

    # 5. Run Data Processing
    - name: Data Processing & Feature Engineering
      env:
        HF_TOKEN: ${{ secrets.HF_TOKEN }}
        HF_USERNAME: "iStillWaters"
        DATASET_REPO_NAME: "auto_predictive_maintenance_data"
      run: |
        python src/process_data.py

    # 6. Run Model Training
    - name: Model Training & Registry
      env:
        HF_TOKEN: ${{ secrets.HF_TOKEN }}
        HF_USERNAME: "iStillWaters"
        DATASET_REPO_NAME: "auto_predictive_maintenance_data"
        MODEL_REPO_NAME: "auto_predictive_maintenance_model"
      run: |
        python src/train.py

    # 7. Run App Deployment
    - name: Deploy to Hugging Face Spaces
      env:
        HF_TOKEN: ${{ secrets.HF_TOKEN }}
        HF_USERNAME: "iStillWaters"
        SPACE_NAME: "Engine-Reliability-Dashboard"
      run: |
        python src/deploy.py